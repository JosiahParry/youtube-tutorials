<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>youtube-tutorials - script</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<meta name="twitter:title" content="youtube-tutorials - script">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@josiahparry">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../twitter-geohash/script.html">Geohash</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">youtube-tutorials</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dots/slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dots …</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simple-features/script.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simple Features</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../twitter-geohash/script.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Geohash</span></a>
  </div>
</li>
    </ul>
</div>
    <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#building-the-intuition" id="toc-building-the-intuition" class="nav-link active" data-scroll-target="#building-the-intuition">Building the intuition</a></li>
  <li>
<a href="#z-order-curves" id="toc-z-order-curves" class="nav-link" data-scroll-target="#z-order-curves">Z-order curves</a>
  <ul class="collapse">
<li><a href="#z-coordinates" id="toc-z-coordinates" class="nav-link" data-scroll-target="#z-coordinates">Z-coordinates</a></li>
  </ul>
</li>
  <li><a href="#converting-from-binary-to-geohash" id="toc-converting-from-binary-to-geohash" class="nav-link" data-scroll-target="#converting-from-binary-to-geohash">Converting from binary to geohash</a></li>
  <li>
<a href="#base-32-encoding" id="toc-base-32-encoding" class="nav-link" data-scroll-target="#base-32-encoding">Base 32 encoding</a>
  <ul class="collapse">
<li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">notes</a></li>
  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">script</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><ul>
<li>what is a geohash?</li>
<li>most simply put, a geohash a one dimension representation of two dimensional data</li>
<li>The form of geohashes that we use today were invented in 2008 by a fella named Gustavo Niemeyer.</li>
<li>forms of the algorithm have existed as far back as 1966 created at GM
<ul>
<li>https://en.wikipedia.org/wiki/Geohash</li>
</ul>
</li>
<li>so Gustavo Niemeyer unknowingly rediscovered the same thing only almost half a century later</li>
<li>there are tons of videos out there that describe how you can use a geohash and why you might want to use them, but there are very few that will help you understand them.</li>
<li>as always, my goal here is to have you walk away <em>understanding</em> not just “knowing”
<ul>
<li>there’s an important distinction there</li>
<li>when you know something you can tell me what that is but when you understand you can tell me why it is</li>
</ul>
</li>
</ul>
<section id="building-the-intuition" class="level2"><h2 class="anchored" data-anchor-id="building-the-intuition">Building the intuition</h2>
<ul>
<li>I’m going to be brief on the applications of geohashes, there are other videos for that</li>
<li>an alpha numeric string representation of a coordinate</li>
<li>in other words, using only numbers and letters we can represent an x and y value
<ul>
<li>this has big implications for databases querying that we can get into later</li>
</ul>
</li>
<li>the geohash is a type of spatial index</li>
<li>divide the earth into equal portions along in a square grid</li>
<li>each square is then subdivided into 32 more squares adding a level of precision</li>
<li>then that square can be further subdivided into another grid and so on until we do it 12 times
<ul>
<li>12 is our maximum zoom level.
<ul>
<li>There is a technical reason for this having to do with the total number of bits that can be held by a number</li>
</ul>
</li>
</ul>
</li>
<li>the text based index represents a single grid which has a few handy properties</li>
<li>the text string can be up to 12 characters long. The shorter the string the larger the bounding box</li>
<li>a single letter is the largest area representing a five thousand by five thousand bounding box
<ul>
<li>not too helpful, so adding more levels of precision can help us get closer and closer</li>
</ul>
</li>
<li>when we reach the 12th level of precision we’re within centimeters of our initial location</li>
</ul>
<table class="table">
<thead><tr class="header">
<th>Index Precision</th>
<th>Bounding Box</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>≤ 5,000km X 5,000 Km</td>
</tr>
<tr class="even">
<td>2</td>
<td>≤ 1,250km X 625km</td>
</tr>
<tr class="odd">
<td>3</td>
<td>≤ 156km X 156km</td>
</tr>
<tr class="even">
<td>4</td>
<td>≤ 39.1km X 19.5km</td>
</tr>
<tr class="odd">
<td>5</td>
<td>≤ 4.89km X 4.89km</td>
</tr>
<tr class="even">
<td>6</td>
<td>≤ 1.22km X 0.61km</td>
</tr>
<tr class="odd">
<td>7</td>
<td>≤ 153m X 153m</td>
</tr>
<tr class="even">
<td>8</td>
<td>≤ 38.2m X 19.1m</td>
</tr>
<tr class="odd">
<td>9</td>
<td>≤ 4.77m X 4.77m</td>
</tr>
<tr class="even">
<td>10</td>
<td>≤ 1.19m X 0.596m</td>
</tr>
<tr class="odd">
<td>11</td>
<td>≤ 149mm X 149mm</td>
</tr>
<tr class="even">
<td>12</td>
<td>≤ 37.2mm X 18.6mm</td>
</tr>
</tbody>
</table>
<ul>
<li><p>resolution: https://docs.quadrant.io/quadrant-geohash-algorithm</p></li>
<li><p>so for all intents and purposes we can locate places pretty exactly by using a single string</p></li>
<li><p>another useful property is that points within the same grids share the same prefix</p></li>
<li><p>say, you’re a tourist in Boston and you’ve just gotten off the train at Park Street station to explore the Boston Common and you want to find a nice coffee within a reasonable distance</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">park_street</span> <span class="op">&lt;-</span> <span class="fu">geohashTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geohashTools/man/gh_encode.html">gh_encode</a></span><span class="op">(</span><span class="fl">42.35675660592967</span>, <span class="op">-</span><span class="fl">71.06224330327713</span>, <span class="fl">12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">george_howell</span> <span class="op">&lt;-</span> <span class="fu">geohashTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geohashTools/man/gh_encode.html">gh_encode</a></span><span class="op">(</span><span class="fl">42.35486966028336</span>, <span class="op">-</span><span class="fl">71.06172831916592</span>, <span class="fl">12</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Park Street is located very precisely at the geohash drt2yyy1cxwy. I just so happen to know that there is a great coffee shop quite close by near Downtown Crossing called George Howell which has a geohash of drt2yyqqvxyy.</p>
<p>If we were to query all coffee shop locations that shared the same first 6 characters of our geohash George Howell would definitely show up.</p>
<p>Being able to truncate and filter on a geohash is <em>far</em> more efficient computationally than doing some traditional geographic approach such as taking a location and drawing a distance buffer, extracting every point in that buffer, then calculating a distance matrix.</p>
<p>That’s the gist of the geohash. And that’s about just as much as you need to know to minimally use geohashes. And that’s where most videos will stop. But that’s not enough because we don’t actually understand how we make a geohash. We’re going to spend the rest of this time walking through the geohash algorithm step by step in such a way thay you will be able to implement it yourself afterwards.</p>
</section><section id="z-order-curves" class="level2"><h2 class="anchored" data-anchor-id="z-order-curves">Z-order curves</h2>
<p>At the root, a geohash is an implementation of a Z-order curve. It’s not necessary to understand Z-order curves in all of of their intricacies to truly understand geohashes but its worth diving into a bit. Shoot, I don’t even fully get them.</p>
<p>In the field of mathematical analysis there is an entire subfield dedicated to what are called “space filling curves.” In essence, they are a suite of algorithms that map 2 or 3 dimensional data into a single dimension. The Z-order curve is one of these space filling curves that is used to map 2 dimensional data into one dimension. The Z-order curve is used a bunch in big data technologies like Apache Spark, Cassandra, and Parquet to speed up search.</p>
<p>But there is no way I can do justice to explaining them so I really recommend that you watch this 3blue1brown video on them.</p>
<p>In geography we are always dealing in at least 2 dimensions: longitude and latitude. Using a Z-order curve we can encode longitude and latitude as a single value and that’s exactly what geohash does. But how?</p>
<p>Now pay attention here. This is the only important part about a z-order curve I want you to care about.</p>
<p>Say we have two numbers <code>x</code> and <code>y</code>. <code>x</code> is equal to 23 and <code>y</code> is equal to 42. From <code>x</code> and <code>y</code> we can create a third value, <code>z</code> (hence the name).</p>
<section id="z-coordinates" class="level3"><h3 class="anchored" data-anchor-id="z-coordinates">Z-coordinates</h3>
<p>I’m about to make a leap here. Stay with me. Both of these numbers can be represented in binary as a combination of 0’s and 1s. In binary, 23 is <code>00010111</code> and 42 is <code>00101010</code>. Each number is represented by 8 different 0s or 1s so they are 8 bit numbers—integers, to be exact. To get our z-coordinate all we need to do is “interleave” them.</p>
<p>Interleaving sounds fancy but it’s super simple. I like to think of interleaving as weaving two leavings together by alternating one and another. Our z-coordinate is the sequence of bits that results from interleaving <code>x</code> and <code>y</code>.</p>
<p>To do this, we take the first value of <code>x</code> followed by the first value of <code>y</code>. Then we append the second value of <code>x</code> followed by the second value of <code>y</code>. We do this until we’ve exhausted all bits in <code>x</code> and <code>y</code>.</p>
<p>The result is a sequence of 16 bits <code>0000011001101110</code>. Instead of having 8 bits, we now have 16 bits. Or a 16 bit integer. When converted from binary we get the value of 1646. This is an important detail, when we interleave two numbers we always double the number of bits used.</p>
<ul>
<li>that interleaving of bits is all that a geohash really is.</li>
</ul>
<p>So do we just convert our x and y values to binary and then interleave them? Well, no. Of course it’s not that simple. There are two ah hahs! The first has to do with the limitations of modern computing.</p>
<p>Back to bits.</p>
<p>In R, and python, and most other systems, numbers that contain values after the decimal place are known as “double precision floating points” which is a really long way of saying they are 64 bit numbers. Again, that means that our numbers are represented by 64 sequential 1s or 0s.</p>
<p>When we interleave two floats we will end up with a 128 bit number. That’s a bit more than most languages and tools are able to handle. Though that’s going to change in the next few years I bet.</p>
<p>Since we can only handle 64 bits, we have to truncate x and y to 32 bits so that when we interleave the two we end up with 64 bits.</p>
<p>The geohash algorithm implements a pretty creative way of representing numbers as binary. The binary representation is actually a way of specifying the location on the numberline.</p>
<p>Start with an X value. X can fall anywhere in the interval [-180, 180). We break that interval into two in the middle that is left inclusive. If the value falls in the left interval then it gets the value of <code>0</code>. If it falls in the right interval, then it gets the value of <code>1</code>. We can do this up to 32 times–remember, 32 bits!</p>
<p>For the value 19 it falls into the right interval so the first bit is the value of <code>1</code>. Now we set our initial interval to <code>[0, 180)</code>. We again partition it in the middle into 2 intervals. Since 19 falls in the left interval it gets the value of 0. So on an so forth until we do this 32 times!</p>
<p>We do the same thing for latitude but the initial bounds are different. They are <code>[-90, 90)</code>. Again, repeat this 32 times.</p>
<p>We can look at what this might look like on the plane.</p>
<p>We start with a point that is in the upper left quadrant. We partition on our longitude. Since it’s in the right interval it gets the value 1. Now we partition it again. It’s in the left, it gets the value of 0. Again we partition. It is in the right. It gets the value of 1. One last time we partiion. It falls into the right interval so it gets the value of 1.</p>
<p>Once we have completed our encoding on longitude we can begin encoding our latitude. The point falls in the right interval which, when viewed on the plane, is actually the top one. And again, its in the top. So far we have the bits 1 and 1. Then again. This time it is on the bottom. It get’s a 0. The last time it is at the top and gets a 1.</p>
<p>When we interleave the results of our encoding we get the value of <code>1 1 0 1 1 0 1 1</code>.</p>
</section></section><section id="converting-from-binary-to-geohash" class="level2"><h2 class="anchored" data-anchor-id="converting-from-binary-to-geohash">Converting from binary to geohash</h2>
<p>I told you that a geohash is just a z-coordinate. But now we have a binary z-coordinate and it looks <em>nothing</em> like the geohashes I showed you earlier. Well, there’s one last step that we have to take to go from our binary z-coordinate to a geohash.</p>
<p>Geohashes are “base32” encoded. What does that mean?</p>
<p>The number system that we use and are familiar with is called base 10. That’s because we have 10 unique digits that we use to represent values 0-9.</p>
<p>Binary is a base 2 number system because it uses the two digits 0 and 1 to represent values.</p>
<p>The <code>n</code> refers to how many character are in the alphabet being used to represent values.</p>
<p>So base 32 means that there are 32 digits that are used to represent values. These are a combination of letters and numbers. Typically, these are the letters A through Z and the numbers 2 through 7.</p>
<p>Though the Geohash algorithm has it’s own base 32 alphabet called the “geohash alphabet” (wiki source). It contains the numbers 0 through 9 and the entire alphabet except a, i, l, and o because they look similar to numbers (except a)—they just needed 1 fewer character.</p>
<p>To utilze the alphabet we need to define a lookup table that has our characters by position.</p>
</section><section id="base-32-encoding" class="level1"><h1>Base 32 encoding</h1>
<p>Base 32 requires 5 bits to represent each character. Having 5 bits gives us 32 possible possible combinations. From <code>00000</code> being 0 in binary and <code>11111</code> being 31 in binary.</p>
<p>You can think of this as 2 * 2 * 2 * 2 * 2 possibilities or 2^5.</p>
<hr>
<section id="notes" class="level2"><h2 class="anchored" data-anchor-id="notes">notes</h2>
<p>Medium post that helped me get to the last part https://yatmanwong.medium.com/geohash-implementation-explained-2ed9627a61ff Factual blog post http://web.archive.org/web/20220620005549/https://www.factual.com/blog/how-geohashes-work/</p>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>