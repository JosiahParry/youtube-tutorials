<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>youtube-tutorials - Untitled</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<meta name="twitter:title" content="youtube-tutorials - Untitled">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="images/paste-1.png">
<meta name="twitter:creator" content="@josiahparry">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      youtube-tutorials
      </li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">youtube-tutorials</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dots/slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dots ‚Ä¶</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../geohash/script.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geohash script</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../geohash/slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geohash slides</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simple-features/script.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simple Features</span></a>
  </div>
</li>
    </ul>
</div>
    <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#first-impression" id="toc-first-impression" class="nav-link active" data-scroll-target="#first-impression">First impression</a></li>
  <li><a href="#lookup-vectors" id="toc-lookup-vectors" class="nav-link" data-scroll-target="#lookup-vectors">Lookup Vectors</a></li>
  <li><a href="#if-you-dont-need-it-dont-use-it" id="toc-if-you-dont-need-it-dont-use-it" class="nav-link" data-scroll-target="#if-you-dont-need-it-dont-use-it">If you don‚Äôt need it, don‚Äôt use it</a></li>
  <li><a href="#rewrite-function" id="toc-rewrite-function" class="nav-link" data-scroll-target="#rewrite-function">Rewrite function</a></li>
  <li><a href="#benchmark-it" id="toc-benchmark-it" class="nav-link" data-scroll-target="#benchmark-it">Benchmark it</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Untitled</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>About a week ago I posted a video on using R and Rust together with the extendr library. Based on its reception on LinkedIn and Mastodon, people seem to like the prospect quite a bit. Though, who of you have actually tried it out yet? Do you have a Github repo you‚Äôve been working on? Share it in the comments below.</p>
<p>On Wednesday, I had a message in my LinkedIn inbox from a new connection.</p>
<p><img src="images/paste-1.png" class="img-fluid" width="500"></p>
<p>Answers to questions like this are always ‚Äúmaybe‚Äù ü§∑.<br>
So I asked for a reproducible example I can work with.</p>
<p><img src="images/paste-2.png" class="img-fluid" width="450"></p>
<p>Within a couple of hours he shared a github gist that I was able to work with.</p>
<p>To get a sense of the problem, lets look at some of the sample data he provided.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># remotes::install_github("josiahparry/pathattr")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pathattr</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">path10k</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 √ó 4
  path                  dates                                        leads value
  &lt;chr&gt;                 &lt;chr&gt;                                        &lt;dbl&gt; &lt;dbl&gt;
1 tiktok&gt;blog&gt;gs&gt;fb&gt;rtl 2023-04-17&gt;2023-02-25&gt;2023-01-24&gt;2023-03-12‚Ä¶     1 6794.
2 yt&gt;blog&gt;gs&gt;fb&gt;gda     2023-01-18&gt;2023-01-27&gt;2023-02-19&gt;2023-01-01‚Ä¶     1 5981.
3 fb&gt;gs&gt;yt              2023-04-21&gt;2023-02-20&gt;2023-03-23                 1 5801.
4 gda&gt;yt&gt;tiktok&gt;blog    2023-04-24&gt;2023-03-01&gt;2023-05-03&gt;2023-04-29      1 4583.
5 rtl                   2023-02-20                                       1 6735.
6 gda&gt;yt&gt;rtl&gt;tiktok     2023-02-04&gt;2023-02-26&gt;2023-01-09&gt;2023-03-22      1 7238.</code></pre>
</div>
</div>
<p>As I understand it, we are looking at path attribution which is a marketing problem. Users will interact with a company through a number of different platforms or mediums. Each time they interact with company content is referred to as a ‚Äútouch.‚Äù The people that are touched are referred to as leads. These leads have a dollar value attached to them. Typically it is assigned based on the company that you work for. Folks from a fortune 500 company are most likely to have a higher potential value than someone working for a non-profit. Non-profits can‚Äôt spend all that much money.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">path10k</span><span class="op">[[</span><span class="st">"path"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "tiktok&gt;blog&gt;gs&gt;fb&gt;rtl" "yt&gt;blog&gt;gs&gt;fb&gt;gda"     "fb&gt;gs&gt;yt"             
[4] "gda&gt;yt&gt;tiktok&gt;blog"    "rtl"                  </code></pre>
</div>
</div>
<p>To my understanding each of these paths represent all of the media that a customer consumed before they were converted‚Äîmeaning purchased a good.</p>
<p>Each touch point is separated by a greater than sign <code>&gt;</code>. I think this is technically considered Markov Chain Attribution? If you know, put it in the comments.</p>
<p>Each touch has some theoretical impact on you purchasing a good. The order in which you experience content might matter. How much would omitting one of these touches impact your results? That is called a removal effect which is captured in the object <code>removal_effects_table.</code></p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">removal_effects_table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 √ó 2
  channel_name removal_effects_conversion
  &lt;chr&gt;                             &lt;dbl&gt;
1 fb                                 0.2 
2 tiktok                             0.1 
3 gda                                0.3 
4 yt                                 0.1 
5 gs                                 0.6 
6 rtl                                0.05
7 blog                               0.09</code></pre>
</div>
</div>
<p>For each path we want to know the effect of each channel on conversion and how much value we can assign to them. For each row of the data frame we want to return a data frame that looks like so.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co">#&gt;    channel_name   re conversion     value       date</span></span>
<span><span class="co">#&gt; 1:       tiktok 0.10 0.09615385  653.2879 2023-04-17</span></span>
<span><span class="co">#&gt; 2:         blog 0.09 0.08653846  587.9591 2023-02-25</span></span>
<span><span class="co">#&gt; 3:           gs 0.60 0.57692308 3919.7273 2023-01-24</span></span>
<span><span class="co">#&gt; 4:           fb 0.20 0.19230769 1306.5758 2023-03-12</span></span>
<span><span class="co">#&gt; 5:          rtl 0.05 0.04807692  326.6439 2023-03-09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is the function that they wrote to return the desired frame. Let‚Äôs walk through it line by line.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">attribute_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path_str</span>, <span class="va">date_str</span>, <span class="va">outcome</span>, <span class="va">value</span>, <span class="va">retbl</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#break the path_str and date_str into vectors of touch points and dates</span></span>
<span>  <span class="va">touches</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split_1</a></span><span class="op">(</span><span class="va">path_str</span>, <span class="st">"&gt;"</span><span class="op">)</span></span>
<span>  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split_1</a></span><span class="op">(</span><span class="va">date_str</span>, <span class="st">"&gt;"</span><span class="op">)</span></span>
<span>  <span class="co">#remove dates and touches where touches is an empty</span></span>
<span>  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="va">dates</span><span class="op">[</span><span class="va">touches</span> <span class="op">!=</span> <span class="st">''</span><span class="op">]</span></span>
<span>  <span class="va">touches</span> <span class="op">&lt;-</span> <span class="va">touches</span><span class="op">[</span><span class="va">touches</span> <span class="op">!=</span> <span class="st">''</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># create an output dataframe that shows the fraction of</span></span>
<span>  <span class="co"># a lead due to each touch/channel_name by</span></span>
<span>  <span class="co"># 1 getting the removal_effects_conversion </span></span>
<span>  <span class="co">#   (renamed to re) value for each touch</span></span>
<span>  <span class="co"># 2 normalizing re for reach touchpoint by dividing by the </span></span>
<span>  <span class="co">#   sum(re) for all touchpoints in the path_str</span></span>
<span>  <span class="co"># 3 multiplying outcome and value by the renormalized re</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>channel_name <span class="op">=</span> <span class="va">touches</span><span class="op">[</span><span class="va">touches</span><span class="op">!=</span><span class="st">''</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>      <span class="va">retbl</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">channel_name</span>, <span class="va">removal_effects_conversion</span><span class="op">)</span>,</span>
<span>      <span class="st">"channel_name"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span></span>
<span>      re <span class="op">=</span> <span class="va">removal_effects_conversion</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      conversion <span class="op">=</span> <span class="va">outcome</span> <span class="op">*</span> <span class="va">re</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">re</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      value <span class="op">=</span> <span class="va">value</span> <span class="op">*</span> <span class="va">re</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">re</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      date <span class="op">=</span> <span class="va">dates</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Line 3 and 4 is used to split the path and dates string on the <code>&gt;</code> greater than sign and create a vector from them.</p>
<p>Next, lines 6 and 7 are used to remove any empty strings.</p>
<p>Then from lines 16 through 27 the real magic happens using a fairly complex dplyr pipe.</p>
<section id="first-impression" class="level3"><h3 class="anchored" data-anchor-id="first-impression">First impression</h3>
<p>I don‚Äôt know about you all but after programming in R for like 8 years now, I have a pretty decent intuition about things that may cause problems in R code or at least can be simplified or improved. When I look at this there are 3 immediate things I notice.</p>
<p>The first the simplest. The <code>touches</code> vector is filtered to not include any empty strings on line 7. On line 16 the touches vector is filtered again in the creation of the <code>tibble</code>. That‚Äôs redundant code so it can be deleted.</p>
<p>Next, I see that the sum of the <code>re</code> column is calculated twice. We generally want to calculation things as few times as possible.</p>
<p>And lastly, it‚Äôs the elephant in the room. I mean no offense to the author of this code or tidyverse folks in general. But the pipeline is a tinge messy. There‚Äôs <em>a lot</em> going on. And most notably, there is a join onto a table that is selected upon all in one function. That means that every time this function is executed the <code>removal_effects_conversion</code> table is selected and then joined upon. Joins are costly. They‚Äôre slow. Generally, we want to only join tables when its really necessary. And here, I‚Äôm not sure it is.</p>
<p>Let‚Äôs walk through this function step by step. To do that let‚Äôs create R objects as placeholders for the function arguments.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">path_str</span> <span class="op">&lt;-</span> <span class="st">"tiktok&gt;blog&gt;gs&gt;fb&gt;rtl"</span></span>
<span><span class="va">date_str</span> <span class="op">&lt;-</span> <span class="st">"2023-04-17&gt;2023-02-25&gt;2023-01-24&gt;2023-03-12&gt;2023-03-09"</span></span>
<span><span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fl">6794.194</span></span>
<span><span class="va">retbl</span> <span class="op">&lt;-</span> <span class="va">removal_effects_table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With that, lets start running through the function line by line.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">touches</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split_1</a></span><span class="op">(</span><span class="va">path_str</span>, <span class="st">"&gt;"</span><span class="op">)</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split_1</a></span><span class="op">(</span><span class="va">date_str</span>, <span class="st">"&gt;"</span><span class="op">)</span></span>
<span><span class="va">touches</span> <span class="op">&lt;-</span> <span class="va">touches</span><span class="op">[</span><span class="va">touches</span> <span class="op">!=</span> <span class="st">''</span><span class="op">]</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="va">dates</span><span class="op">[</span><span class="va">touches</span> <span class="op">!=</span> <span class="st">''</span><span class="op">]</span></span>
<span></span>
<span><span class="va">touches</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "tiktok" "blog"   "gs"     "fb"     "rtl"   </code></pre>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dates</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2023-04-17" "2023-02-25" "2023-01-24" "2023-03-12" "2023-03-09"</code></pre>
</div>
</div>
<p>Great we have two vectors of the same length. Next let‚Äôs begin to take apart the dplyr pipeline. I remove the redundant part of the code. We have a very small data frame.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>channel_name <span class="op">=</span> <span class="va">touches</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 1
  channel_name
  &lt;chr&gt;       
1 tiktok      
2 blog        
3 gs          
4 fb          
5 rtl         </code></pre>
</div>
</div>
<p>What about the join? What is happening here? We‚Äôre joining the removal effects table onto our tiny column it looks like. From looking, I know that only two columns actually exist in the <code>retbl</code> object so I‚Äôm removing the selection simplifying it further.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>channel_name <span class="op">=</span> <span class="va">touches</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">retbl</span>,</span>
<span>  <span class="st">"channel_name"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 2
  channel_name removal_effects_conversion
  &lt;chr&gt;                             &lt;dbl&gt;
1 tiktok                             0.1 
2 blog                               0.09
3 gs                                 0.6 
4 fb                                 0.2 
5 rtl                                0.05</code></pre>
</div>
</div>
<p>Now the result here is actually very simple. We just want to know the removal effect associated with each channel. Rather than turning a vector into a data frame and then joining the table on, I want to let you in on one of my favorite tricks.</p>
</section><section id="lookup-vectors" class="level2"><h2 class="anchored" data-anchor-id="lookup-vectors">Lookup Vectors</h2>
<p>I‚Äôm not sure if you know this, but all vectors can have names. Most people who grew up on the tidyverse might not actually know this. I was fortunate to have struggled without it for a few years before it became its own metapackage.</p>
<p>Let‚Äôs look at an example. Let‚Äôs create a vector containing the values 1 through 26 to represent the indexes of the alphabet.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">alpha_index</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">26</span></span>
<span><span class="va">alpha_index</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26</code></pre>
</div>
</div>
<p>What if we want to access the index based on the letter in the alphabet? Well, we can give this integer vector names. We can use the built in <code>letters</code> object to assign the names like so:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">alpha_index</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">letters</span></span>
<span><span class="va">alpha_index</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> a  b  c  d  e  f  g  h  i  j  k  l  m  n  o  p  q  r  s  t  u  v  w  x  y  z 
 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 </code></pre>
</div>
</div>
<p>Now when we print it out, we see that the alphabet is printed above the index.</p>
<p>Why this is so cool is because we can access the values based on the names rather than just position. I can create a character vector of letters of my name and extract the values.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">alpha_index</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"j"</span>, <span class="st">"o"</span>, <span class="st">"s"</span>, <span class="st">"i"</span>, <span class="st">"a"</span>, <span class="st">"h"</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> j  o  s  i  a  h 
10 15 19  9  1  8 </code></pre>
</div>
</div>
<p>Maybe you already see where this is going. Instead of joining a whole entire table, we can create a look up vector instead. It‚Äôs far simpler, and most importantly, far faster. We can do this by using the <code><a href="https://rdrr.io/r/stats/setNames.html">setNames()</a></code> function. The first argument is the vector the second is the names.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span></span>
<span>    <span class="va">retbl</span><span class="op">[[</span><span class="st">"removal_effects_conversion"</span><span class="op">]</span><span class="op">]</span>, </span>
<span>    <span class="va">retbl</span><span class="op">[[</span><span class="st">"channel_name"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lookup</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    fb tiktok    gda     yt     gs    rtl   blog 
  0.20   0.10   0.30   0.10   0.60   0.05   0.09 </code></pre>
</div>
</div>
<p>With this we can simplify the code greatly already. We can lookup the return effects value by selecting from the <code>lookup</code> vector the values from our <code>touches</code> vector</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lookup</span><span class="op">[</span><span class="va">touches</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tiktok   blog     gs     fb    rtl 
  0.10   0.09   0.60   0.20   0.05 </code></pre>
</div>
</div>
<p>Let‚Äôs bench mark this alone:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>    lookup_table <span class="op">=</span> <span class="va">lookup</span><span class="op">[</span><span class="va">touches</span><span class="op">]</span>,</span>
<span>    dplyr_join <span class="op">=</span> <span class="op">{</span></span>
<span>        <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>channel_name <span class="op">=</span> <span class="va">touches</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>              <span class="va">retbl</span>,</span>
<span>              <span class="st">"channel_name"</span></span>
<span>            <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    check <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 √ó 6
  expression        min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt;   &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 lookup_table    164ns    246ns  3750654.        0B      0  
2 dplyr_join      576¬µs    628¬µs     1489.    2.99KB     34.9</code></pre>
</div>
</div>
<p>This alone is a huge performance gain.</p>
<p>If you don‚Äôt need a data frame don‚Äôt use one.</p>
</section><section id="if-you-dont-need-it-dont-use-it" class="level2"><h2 class="anchored" data-anchor-id="if-you-dont-need-it-dont-use-it">If you don‚Äôt need it, don‚Äôt use it</h2>
<p>We can rewrite the rest of the function using only vectors now that we figured it out!</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">re</span> <span class="op">&lt;-</span> <span class="va">lookup</span><span class="op">[</span><span class="va">touches</span><span class="op">]</span></span>
<span><span class="va">re_tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">re</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">conversion</span> <span class="op">&lt;-</span> <span class="va">outcome</span> <span class="op">*</span> <span class="va">re</span> <span class="op">/</span> <span class="va">re_tot</span></span>
<span><span class="va">val</span> <span class="op">&lt;-</span> <span class="va">value</span> <span class="op">*</span> <span class="va">re</span> <span class="op">/</span> <span class="va">re_tot</span></span>
<span></span>
<span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    channel_name <span class="op">=</span> <span class="va">touches</span>,</span>
<span>    <span class="va">re</span>, </span>
<span>    <span class="va">conversion</span>,</span>
<span>    value <span class="op">=</span> <span class="va">val</span>,</span>
<span>    date <span class="op">=</span> <span class="va">dates</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 5
  channel_name    re conversion value date      
  &lt;chr&gt;        &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     
1 tiktok        0.1      0.0962  653. 2023-04-17
2 blog          0.09     0.0865  588. 2023-02-25
3 gs            0.6      0.577  3920. 2023-01-24
4 fb            0.2      0.192  1307. 2023-03-12
5 rtl           0.05     0.0481  327. 2023-03-09</code></pre>
</div>
</div>
</section><section id="rewrite-function" class="level2"><h2 class="anchored" data-anchor-id="rewrite-function">Rewrite function</h2>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">attr_path2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path_str</span>, <span class="va">date_str</span>, <span class="va">outcome</span>, <span class="va">value</span>, <span class="va">lookup</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">touches</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split_1</a></span><span class="op">(</span><span class="va">path_str</span>,<span class="st">"&gt;"</span><span class="op">)</span></span>
<span>  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split_1</a></span><span class="op">(</span><span class="va">date_str</span>,<span class="st">"&gt;"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="va">dates</span><span class="op">[</span><span class="va">touches</span> <span class="op">!=</span> <span class="st">''</span><span class="op">]</span></span>
<span>  <span class="va">touches</span> <span class="op">&lt;-</span> <span class="va">touches</span><span class="op">[</span><span class="va">touches</span> <span class="op">!=</span> <span class="st">''</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">lookup</span><span class="op">[</span><span class="va">touches</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">re_tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">re</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">conversion</span> <span class="op">&lt;-</span> <span class="va">outcome</span> <span class="op">*</span> <span class="va">re</span> <span class="op">/</span> <span class="va">re_tot</span></span>
<span>  <span class="va">value</span> <span class="op">&lt;-</span> <span class="va">value</span> <span class="op">*</span> <span class="va">re</span> <span class="op">/</span> <span class="va">re_tot</span></span>
<span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    channel_name <span class="op">=</span> <span class="va">touches</span>,</span>
<span>    <span class="va">re</span>,</span>
<span>    <span class="va">conversion</span>,</span>
<span>    <span class="va">value</span>,</span>
<span>    date <span class="op">=</span> <span class="va">dates</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="benchmark-it" class="level2"><h2 class="anchored" data-anchor-id="benchmark-it">Benchmark it</h2>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>    original <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/pathattr/man/attribute_path.html">attribute_path</a></span><span class="op">(</span><span class="va">path_str</span>, <span class="va">date_str</span>, <span class="va">outcome</span>, <span class="va">value</span>, <span class="va">retbl</span><span class="op">)</span>,</span>
<span>    base_R <span class="op">=</span> <span class="fu">attr_path2</span><span class="op">(</span><span class="va">path_str</span>, <span class="va">date_str</span>, <span class="va">outcome</span>, <span class="va">value</span>, <span class="va">lookup</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 √ó 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 original     2.44ms   2.96ms      258.    2.25MB     28.9
2 base_R     396.72¬µs 449.63¬µs     1997.   59.78KB     41.9</code></pre>
</div>
</div>
<p>Already we see a bunch of performance gains at a single iteration. However this intended to be applied to an entire data frame by using purrr.</p>
<p>#</p>
<p><img src="images/paste-3.png" class="img-fluid"></p>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>